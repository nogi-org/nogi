name: CI/CD Pipeline

on:
  pull_request:
    branches:
      - main  # main ë¸Œëœì¹˜ì— pushí•˜ë©´ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ ì¶”ê°€

jobs:
  # ğŸ”¹ 1ï¸âƒ£ Build & Test (Dockerfileì„ Artifactë¡œ ì €ì¥)
  build-and-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && contains(join(github.event.pull_request.labels.*.name, ','), 'deploy-backend'))

    steps:
      # âœ… Git Clone
      - name: Checkout Repository
        uses: actions/checkout@v3

      # âœ… application-prod.yml & application-test.ymlì„ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ìƒì„±
      - name: Create application.yml files
        run: |
          mkdir -p backend/src/main/resources
          echo "${{ secrets.APPLICATION_PROD_YML }}" > backend/src/main/resources/application-prod.yml
          echo "${{ secrets.APPLICATION_TEST_YML }}" > backend/src/main/resources/application-test.yml

      # âœ… Java 17 ì„¤ì¹˜
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # âœ… Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x backend/gradlew

      # âœ… Build (í…ŒìŠ¤íŠ¸ í¬í•¨)
      - name: Build with Gradle (Including Tests)
        run: |
          cd backend
          ./gradlew clean build -x test  # í…ŒìŠ¤íŠ¸ í¬í•¨í•˜ë ¤ë©´ `-x test` ì œê±°

      # âœ… Dockerfileì„ Artifactë¡œ ì—…ë¡œë“œ
      - name: Upload Dockerfile as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dockerfile
          path: backend/Dockerfile  # Dockerfileì´ ìœ„ì¹˜í•œ ê²½ë¡œ

      # âœ… Build ê²°ê³¼ë¬¼ (JAR íŒŒì¼)ë„ Artifactë¡œ ì—…ë¡œë“œ
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: backend/build/libs/*.jar  # ë¹Œë“œëœ JAR íŒŒì¼ ì—…ë¡œë“œ

  # ğŸ”¹ 2ï¸âƒ£ Docker Image Build & Push
  docker-build-and-push:
    runs-on: ubuntu-latest
    needs: build-and-test  # build-and-test ì™„ë£Œ í›„ ì‹¤í–‰

    steps:
      # âœ… Dockerfile Artifact ë‹¤ìš´ë¡œë“œ
      - name: Download Dockerfile Artifact
        uses: actions/download-artifact@v4
        with:
          name: dockerfile
          path: backend/  # Dockerfileì„ ì €ì¥í•  ìœ„ì¹˜

      # âœ… Build ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ (JAR íŒŒì¼)
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: backend/build/libs/  # ë¹Œë“œëœ JAR ì €ì¥

      # âœ… Docker Buildx ì„¤ì •
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # âœ… Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # âœ… Docker ì´ë¯¸ì§€ Build & Push
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: backend  # Spring Boot í”„ë¡œì íŠ¸ í´ë” ê¸°ì¤€
          push: true
          tags: nogiteam/nogi-api:latest, nogiteam/nogi-api:${{ github.sha }}

  # ğŸ”¹ 3ï¸âƒ£ Deploy to EC2 via SSH
  deploy-to-ec2:
    runs-on: ubuntu-latest
    needs: docker-build-and-push  # Docker Build ì™„ë£Œ í›„ ì‹¤í–‰

    steps:
      # âœ… EC2ì— SSHë¡œ ì ‘ì† í›„ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo ls
            cd /home/ubuntu/nogi
            echo "Pulling the latest Docker image..."
            docker pull nogiteam/nogi-api:latest
            echo "Running the deployment script..."
            echo ls
            chmod +x deploy.sh
            ./deploy.sh
